# Capability patterns for Node.js
#
# Covers CommonJS require(), ESM import from '', and dynamic import() calls.
# node: prefix variants are included for Node 18+ explicit built-in imports.
# Call-site patterns are matched as substrings of each source line.
#
# Capabilities: fs:read, fs:write, network, exec, env, unsafe, crypto, reflect, plugin
#
# To add a pattern: append an entry to imports or call_sites and open a PR.

name: node

# import_patterns: npm package / Node built-in name → capabilities
imports:
  # ── Built-ins: Filesystem ─────────────────────────────────────────────────
  fs:                   [fs:read, fs:write]
  node:fs:              [fs:read, fs:write]
  fs/promises:          [fs:read, fs:write]
  node:fs/promises:     [fs:read, fs:write]
  path:                 [fs:read]
  node:path:            [fs:read]
  readline:             [fs:read]
  node:readline:        [fs:read]
  stream:               [fs:read, fs:write]
  node:stream:          [fs:read, fs:write]
  stream/promises:      [fs:read, fs:write]
  node:stream/promises: [fs:read, fs:write]
  buffer:               [fs:read]
  node:buffer:          [fs:read]
  zlib:                 [fs:read, fs:write]
  node:zlib:            [fs:read, fs:write]

  # ── Built-ins: Environment / OS ───────────────────────────────────────────
  os:                   [env]
  node:os:              [env]
  process:              [env]
  node:process:         [env]
  querystring:          [env]
  node:querystring:     [env]

  # ── Built-ins: Execution ──────────────────────────────────────────────────
  child_process:        [exec]
  node:child_process:   [exec]
  worker_threads:       [exec]
  node:worker_threads:  [exec]
  cluster:              [exec]
  node:cluster:         [exec]

  # ── Built-ins: Network ────────────────────────────────────────────────────
  net:                  [network]
  node:net:             [network]
  http:                 [network]
  node:http:            [network]
  https:                [network]
  node:https:           [network]
  http2:                [network]
  node:http2:           [network]
  tls:                  [network, crypto]
  node:tls:             [network, crypto]
  dgram:                [network]
  node:dgram:           [network]
  dns:                  [network]
  node:dns:             [network]
  dns/promises:         [network]
  node:dns/promises:    [network]
  url:                  [network]
  node:url:             [network]

  # ── Built-ins: Crypto / unsafe ────────────────────────────────────────────
  crypto:               [crypto]
  node:crypto:          [crypto]
  vm:                   [unsafe]
  node:vm:              [unsafe]

  # ── Built-ins: Dynamic loading ────────────────────────────────────────────
  module:               [plugin]
  node:module:          [plugin]

  # ── HTTP clients ──────────────────────────────────────────────────────────
  axios:                [network]
  got:                  [network]
  node-fetch:           [network]
  superagent:           [network]
  ky:                   [network]
  undici:               [network]
  needle:               [network]
  cross-fetch:          [network]
  isomorphic-fetch:     [network]
  isomorphic-unfetch:   [network]
  bent:                 [network]
  wretch:               [network]
  ofetch:               [network]

  # ── Web frameworks ────────────────────────────────────────────────────────
  express:              [network]
  fastify:              [network]
  koa:                  [network]
  hapi:                 [network]
  "@hapi/hapi":         [network]
  restify:              [network]
  sails:                [network, fs:read]
  feathers:             [network]
  "@feathersjs/feathers": [network]
  next:                 [network, fs:read, exec]
  nuxt:                 [network, fs:read, exec]
  "@nestjs/core":       [network]
  "@nestjs/common":     [network]
  "@nestjs/platform-express": [network]
  remix:                [network, fs:read]
  astro:                [network, fs:read, exec]

  # ── Databases / ORM ───────────────────────────────────────────────────────
  mongoose:             [network]
  sequelize:            [network]
  typeorm:              [network]
  knex:                 [network]
  "@prisma/client":     [network]
  pg:                   [network]
  pg-promise:           [network]
  postgres:             [network]
  mysql:                [network]
  mysql2:               [network]
  better-sqlite3:       [fs:read, fs:write]
  sqlite3:              [fs:read, fs:write]
  "@planetscale/database": [network]
  "@vercel/kv":         [network]
  "@neondatabase/serverless": [network]

  # ── Cache / KV stores ─────────────────────────────────────────────────────
  redis:                [network]
  ioredis:              [network]
  "@upstash/redis":     [network]
  lru-cache:            []
  node-cache:           []
  keyv:                 [network]

  # ── Cloud: AWS ────────────────────────────────────────────────────────────
  "aws-sdk":                         [network, fs:read, fs:write]
  "@aws-sdk/client-s3":              [network, fs:read, fs:write]
  "@aws-sdk/lib-storage":            [network, fs:read, fs:write]
  "@aws-sdk/client-dynamodb":        [network]
  "@aws-sdk/lib-dynamodb":           [network]
  "@aws-sdk/client-sqs":             [network]
  "@aws-sdk/client-sns":             [network]
  "@aws-sdk/client-lambda":          [network, exec]
  "@aws-sdk/client-ec2":             [network]
  "@aws-sdk/client-ecs":             [network, exec]
  "@aws-sdk/client-ssm":             [network, env]
  "@aws-sdk/client-secrets-manager": [network, env, crypto]
  "@aws-sdk/client-kms":             [network, crypto]
  "@aws-sdk/client-iam":             [network]
  "@aws-sdk/client-cloudwatch":      [network]
  "@aws-sdk/client-cloudformation":  [network]
  "@aws-sdk/client-ses":             [network]
  "@aws-sdk/client-eventbridge":     [network]
  "@aws-sdk/client-cognito-identity-provider": [network, crypto]
  "@aws-sdk/credential-provider-node": [env, network]

  # ── Cloud: Google ─────────────────────────────────────────────────────────
  "@google-cloud/storage":    [network, fs:read, fs:write]
  "@google-cloud/firestore":  [network]
  "@google-cloud/bigquery":   [network]
  "@google-cloud/pubsub":     [network]
  "@google-cloud/tasks":      [network]
  "@google-cloud/run":        [network, exec]
  "@google-cloud/logging":    [network, fs:write]
  firebase:                   [network]
  "firebase-admin":           [network, fs:read, fs:write]
  "firebase/app":             [network]
  "firebase/firestore":       [network]
  "firebase/storage":         [network, fs:read, fs:write]
  "firebase/auth":            [network, crypto]

  # ── Cloud: Azure ──────────────────────────────────────────────────────────
  "@azure/storage-blob":      [network, fs:read, fs:write]
  "@azure/identity":          [network, crypto]
  "@azure/keyvault-secrets":  [network, crypto]
  "@azure/cosmos":            [network]
  "@azure/service-bus":       [network]

  # ── Auth / Crypto ─────────────────────────────────────────────────────────
  bcrypt:               [crypto]
  bcryptjs:             [crypto]
  argon2:               [crypto]
  jsonwebtoken:         [crypto]
  jose:                 [crypto]
  "@auth0/nextjs-auth0": [crypto, network]
  "next-auth":          [crypto, network]
  passport:             [crypto, network]
  "passport-local":     [crypto]
  "passport-jwt":       [crypto]
  "passport-google-oauth20": [crypto, network]
  "passport-facebook":  [crypto, network]
  oauth2orize:          [crypto, network]
  speakeasy:            [crypto]
  otplib:               [crypto]
  "node-otp":           [crypto]
  "qrcode":             [fs:write]
  "otpauth":            [crypto]

  # ── Environment / Config ──────────────────────────────────────────────────
  dotenv:               [env]
  "@dotenvx/dotenvx":   [env]
  config:               [env, fs:read]
  nconf:                [env, fs:read]
  convict:              [env, fs:read]
  "env-var":            [env]
  "@t3-oss/env-core":   [env]
  "@t3-oss/env-nextjs": [env]
  envalid:              [env]

  # ── Process / system ─────────────────────────────────────────────────────
  shelljs:              [exec, fs:read, fs:write]
  execa:                [exec]
  "cross-spawn":        [exec]
  which:                [exec]
  "node-pty":           [exec]
  systeminformation:    [exec, env]
  pm2:                  [exec, network]
  pidusage:             [exec]
  "@actions/core":      [env, exec]
  "@actions/exec":      [exec]

  # ── Filesystem (third-party) ──────────────────────────────────────────────
  "fs-extra":           [fs:read, fs:write]
  glob:                 [fs:read]
  "fast-glob":          [fs:read]
  chokidar:             [fs:read]
  archiver:             [fs:read, fs:write]
  "adm-zip":            [fs:read, fs:write]
  jszip:                [fs:read, fs:write]
  "node-tar":           [fs:read, fs:write]
  "tar-stream":         [fs:read, fs:write]
  multer:               [fs:write]
  formidable:           [fs:write]
  busboy:               [fs:write]
  tmp:                  [fs:write]
  tempy:                [fs:write]
  "temp-dir":           [fs:read]
  "make-dir":           [fs:write]
  "del":                [fs:write]
  rimraf:               [fs:write]
  mkdirp:               [fs:write]
  "graceful-fs":        [fs:read, fs:write]
  vinyl:                [fs:read, fs:write]

  # ── Media / document processing ───────────────────────────────────────────
  sharp:                [fs:read, fs:write, exec]
  jimp:                 [fs:read, fs:write]
  canvas:               [fs:read, fs:write]
  "pdf-lib":            [fs:read, fs:write]
  pdfkit:               [fs:write]
  xlsx:                 [fs:read, fs:write]
  "csv-parser":         [fs:read]
  papaparse:            [fs:read]
  "fast-csv":           [fs:read, fs:write]
  exceljs:              [fs:read, fs:write]
  "puppeteer":          [exec, network, fs:read, fs:write]
  "puppeteer-core":     [exec, network, fs:read, fs:write]
  playwright:           [exec, network, fs:read, fs:write]
  "@playwright/test":   [exec, network, fs:read, fs:write]
  "selenium-webdriver": [exec, network]
  "cheerio":            []
  jsdom:                [unsafe, network]

  # ── Messaging / WebSockets ────────────────────────────────────────────────
  nodemailer:           [network]
  "@sendgrid/mail":     [network]
  "@mailchimp/mailchimp_marketing": [network]
  twilio:               [network]
  pusher:               [network]
  "pusher-js":          [network]
  "socket.io":          [network]
  "socket.io-client":   [network]
  ws:                   [network]
  mqtt:                 [network]
  amqplib:              [network]
  "kafka-node":         [network]
  kafkajs:              [network]
  nats:                 [network]
  "@nats-io/nats-core": [network]

  # ── Payment ───────────────────────────────────────────────────────────────
  stripe:               [network, crypto]
  "paypal-rest-sdk":    [network]
  braintree:            [network, crypto]
  "@paddle/paddle-node-sdk": [network]

  # ── Logging / Observability ───────────────────────────────────────────────
  winston:              [fs:write, network]
  pino:                 [fs:write]
  bunyan:               [fs:write]
  morgan:               [fs:write]
  "@sentry/node":       [network]
  "@sentry/nextjs":     [network]
  newrelic:             [network]
  "datadog-metrics":    [network]
  "@datadog/datadog-api-client": [network]
  dd-trace:             [network]
  "@opentelemetry/api": [network]
  "@opentelemetry/sdk-node": [network]

  # ── Build tools (loaded at runtime → plugin + fs) ─────────────────────────
  webpack:              [fs:read, fs:write, exec, plugin]
  vite:                 [fs:read, fs:write, exec]
  esbuild:              [fs:read, fs:write, exec]
  rollup:               [fs:read, fs:write]
  parcel:               [fs:read, fs:write, exec]
  gulp:                 [fs:read, fs:write, exec]
  grunt:                [fs:read, fs:write, exec]
  "@babel/core":        [fs:read, fs:write, plugin]
  typescript:           [fs:read, fs:write, exec]
  tsx:                  [fs:read, exec]
  "ts-node":            [fs:read, exec]

  # ── Reflection / meta-programming ────────────────────────────────────────
  "reflect-metadata":   [reflect]
  "class-transformer":  [reflect]
  "class-validator":    [reflect]

# call_sites: substring patterns matched against each source line
call_sites:
  # ── Code execution / sandbox escape ───────────────────────────────────────
  "eval(":                   [unsafe]
  "new Function(":           [unsafe]
  "vm.runInNewContext(":     [unsafe]
  "vm.runInThisContext(":    [unsafe]
  "vm.runInContext(":        [unsafe]
  "vm.compileFunction(":     [unsafe]
  "vm.Script(":              [unsafe]
  "require('vm')":           [unsafe]

  # ── Process execution ─────────────────────────────────────────────────────
  "exec(":                   [exec]
  "execSync(":               [exec]
  "execFile(":               [exec]
  "execFileSync(":           [exec]
  "spawn(":                  [exec]
  "spawnSync(":              [exec]
  "fork(":                   [exec]
  "process.exit(":           [exec]
  "process.kill(":           [exec]
  "process.abort(":          [exec]
  "process.binding(":        [unsafe, exec]
  "process.chdir(":          [fs:read]
  "process.cwd(":            [fs:read]

  # ── Network ───────────────────────────────────────────────────────────────
  "fetch(":                  [network]
  "axios.":                  [network]
  "axios.get(":              [network]
  "axios.post(":             [network]
  "axios.put(":              [network]
  "axios.patch(":            [network]
  "axios.delete(":           [network]
  "request(":                [network]
  "got(":                    [network]
  "got.get(":                [network]
  "got.post(":               [network]
  "superagent.":             [network]

  # ── Filesystem reads ──────────────────────────────────────────────────────
  "readFile":                [fs:read]
  "readFileSync":            [fs:read]
  "readdir":                 [fs:read]
  "readdirSync":             [fs:read]
  "readlink":                [fs:read]
  "readlinkSync":            [fs:read]
  "stat(":                   [fs:read]
  "statSync(":               [fs:read]
  "lstat(":                  [fs:read]
  "lstatSync(":              [fs:read]
  "realpath(":               [fs:read]
  "realpathSync(":           [fs:read]
  "access(":                 [fs:read]
  "accessSync(":             [fs:read]
  "createReadStream(":       [fs:read]
  "opendir(":                [fs:read]
  "opendirSync(":            [fs:read]

  # ── Filesystem writes ─────────────────────────────────────────────────────
  "writeFile":               [fs:write]
  "writeFileSync":           [fs:write]
  "appendFile":              [fs:write]
  "appendFileSync":          [fs:write]
  "unlink(":                 [fs:write]
  "unlinkSync(":             [fs:write]
  "rmdir(":                  [fs:write]
  "rmdirSync(":              [fs:write]
  "rm(":                     [fs:write]
  "rmSync(":                 [fs:write]
  "mkdir(":                  [fs:write]
  "mkdirSync(":              [fs:write]
  "mkdtemp(":                [fs:write]
  "mkdtempSync(":            [fs:write]
  "rename(":                 [fs:write]
  "renameSync(":             [fs:write]
  "copyFile(":               [fs:write]
  "copyFileSync(":           [fs:write]
  "symlink(":                [fs:write]
  "symlinkSync(":            [fs:write]
  "link(":                   [fs:write]
  "linkSync(":               [fs:write]
  "chmod(":                  [fs:write]
  "chmodSync(":              [fs:write]
  "chown(":                  [fs:write]
  "chownSync(":              [fs:write]
  "truncate(":               [fs:write]
  "truncateSync(":           [fs:write]
  "createWriteStream(":      [fs:write]

  # ── Environment ───────────────────────────────────────────────────────────
  "process.env":             [env]

  # ── Crypto call sites ─────────────────────────────────────────────────────
  ".createHash(":            [crypto]
  ".createHmac(":            [crypto]
  ".createCipheriv(":        [crypto]
  ".createDecipheriv(":      [crypto]
  ".createSign(":            [crypto]
  ".createVerify(":          [crypto]
  ".createDiffieHellman(":   [crypto]
  ".createECDH(":            [crypto]
  ".generateKeyPair(":       [crypto]
  ".generateKeyPairSync(":   [crypto]
  ".randomBytes(":           [crypto]
  ".randomFill(":            [crypto]
  ".randomInt(":             [crypto]
  ".randomUUID(":            [crypto]
  ".scrypt(":                [crypto]
  ".scryptSync(":            [crypto]
  ".pbkdf2(":                [crypto]
  ".pbkdf2Sync(":            [crypto]
  ".sign(":                  [crypto]
  ".verify(":                [crypto]

  # ── Dynamic loading ───────────────────────────────────────────────────────
  "createRequire(":          [plugin]
  "require.resolve(":        [plugin]
  "Module._load(":           [plugin]
  "Module._resolveFilename(": [plugin]
